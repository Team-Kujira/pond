#!/usr/bin/env python3

import argparse
import subprocess
import shutil
import sys
import os
import json
import requests
from urllib.parse import urlparse

TAGS = [
    "v0.1.0",
    "oracle"
]


def parse_args():
    parser = argparse.ArgumentParser()

    parser.add_argument("--namespace", default="teamkujira")

    subparsers = parser.add_subparsers()
    subparsers.required = True
    subparsers.dest = "command"

    init_parser = subparsers.add_parser("init", help="initialize new pond")
    init_parser.add_argument("--nodes", type=int, default=1,
                             help="number of validators")
    init_parser.add_argument("--podman", action="store_true",
                             help="use podman")
    init_parser.add_argument("--docker", action="store_true",
                             help="use docker")
    init_parser.add_argument("--tag", default=TAGS[0], help="tag")

    start_parser = subparsers.add_parser("start", help="start components")
    start_parser.add_argument("target", nargs="?")

    stop_parser = subparsers.add_parser("stop", help="stop components")
    stop_parser.add_argument("target", nargs="?")

    subparsers.add_parser("info", help="info components")

    subparsers.add_parser("tags", help="print available tags")

    return parser.parse_args()


def start_node_cmd(cmd, namespace, name, version, home, ports):
    port_args = " ".join([f"-p 127.0.0.1:{x}:{x}" for x in ports])
    uid = os.getuid()

    commands = {
        "docker": [
            f"docker rm {name}".split(),
            f"docker run -e USER={uid} -d {port_args} --network pond --name {name} --network-alias {name} -v {home}/{name}:/kujira {namespace}/kujira:{version} kujirad --home /kujira start".split()
        ],
        "podman": [
            f"podman run --name {name} -d --pod pond -v {home}/{name}:/kujira {namespace}/kujira:{version} kujirad --home /kujira start".split()
        ]
    }

    return commands.get(cmd)


def start_feeder_cmd(cmd, namespace, name, version, home, port):
    uid = os.getuid()

    commands = {
        "docker": [
            f"docker rm {name}".split(),
            f"docker run -e USER={uid} -d -p 127.0.0.1:{port}:{port} --network pond --network-alias {name} --name {name} -v {home}/{name}:/feeder {namespace}/feeder:{version} price-feeder config.toml".split()
        ],
        "podman": [
            f"podman run --name {name} -d --pod pond -v {home}/{name}:/feeder {namespace}/feeder:{version} price-feeder config.toml".split()
        ]
    }

    return commands.get(cmd)


def start_relayer_cmd(cmd, namespace, version, home):
    uid = os.getuid()

    commands = {
        "docker": [
            f"docker rm relayer".split(),
            f"docker run -e USER={uid} -d --network pond --network-alias relayer --name relayer -v {home}/relayer:/relayer {namespace}/relayer:{version} link-and-start-pond.sh".split(),
        ],
        "podman": [
            f"podman run --name relayer -d --pod pond -v {home}/relayer:/relayer {namespace}/relayer:{version} link-and-start-pond.sh".split(),
        ]
    }

    return commands.get(cmd)


def init(home, args):
    cmd = None
    extra_args = []

    if args.docker:
        cmd = "docker"
    elif args.podman:
        cmd = "podman"
    else:
        if shutil.which("docker"):
            cmd = "docker"
        elif shutil.which("podman"):
            cmd = "podman"

    if not cmd:
        print("neither docker nor podman found")
        sys.exit(1)

    if cmd == "docker":
        uid = os.getuid()
        cmd = ["docker", "run", "-e", f"USER={uid}"]
    else:
        cmd = ["podman", "run"]
        extra_args = ["--podman"]

    if not os.path.isdir(home):
        os.mkdir(home)
    else:
        if os.listdir(home):
            while True:
                sys.stdout.write(
                    "Delete existing chain data and init new chain? [y/N] "
                )
                choice = input().lower()

                if choice in ["y", "yes"]:
                    break

                if choice in ["", "n", "no"]:
                    return

    cmd += [
        "-v", f"{home}:/tmp/pond",
        f"docker.io/{args.namespace}/prepare:{args.tag}",
        "prepare.py", "--nodes", f"{args.nodes}", "--clear"
    ] + extra_args

    subprocess.run(cmd)


def info(home):
    print(json.dumps(
        json.load(open(f"{home}/pond.json", "r")),
        indent=2,
    ))


def start(args, config, home):
    cmd = config.get("command")
    if not cmd:
        print("command not set")

    ns = args.namespace

    commands = [["sleep", "2"]]

    ports = []
    for chain_id, validators in config["validators"].items():
        for validator in validators:
            node_ports = [
                urlparse(validator["api_url"]).port,
                urlparse(validator["rpc_url"]).port
            ]

            # backwards compatibility
            if "app_url" in validator.keys():
                node_ports.append(urlparse(validator["app_url"]).port)

            ports += node_ports

            name = validator["moniker"].lower()
            version = config["version"]["kujira"]
            commands = start_node_cmd(
                cmd, ns, name, version, home, node_ports
            ) + commands

            if chain_id == "pond-1":
                name = name.replace("kujira", "feeder")
                version = config["version"]["feeder"]
                node_port = urlparse(validator["feeder_url"]).port
                ports.append(node_port)
                commands += start_feeder_cmd(
                    cmd, ns, name, version, home, node_port
                )

    version = config["version"]["relayer"]
    commands += start_relayer_cmd(cmd, ns, version, home)

    port_args = " ".join([f"-p {x}:{x}" for x in ports])

    if cmd == "podman":
        commands = [
            f"podman pod rm --force pond".split(),
            f"podman pod create --name pond {port_args}".split()
        ] + commands

    if cmd == "docker":
        commands = [
            "docker network rm pond".split(),
            "docker network create pond".split()
        ] + commands

    run(commands)


def stop(config):
    cmd = config.get("command")
    if not cmd:
        print("command not set")

    commands = [
        [cmd, "kill", "relayer"]
    ]

    for chain_id, validators in config["validators"].items():
        for validator in validators:
            name = validator["moniker"].lower()
            commands.append([cmd, "kill", name])

            if chain_id == "pond-1":
                name = name.replace("kujira", "feeder")
                commands.append([cmd, "kill", name])

    if cmd == "podman":
        commands.append([cmd, "pod", "kill", "pond"])

    run(commands)


def run(commands):
    for cmd in commands:
        subprocess.run(cmd)


def main():
    args = parse_args()

    home = os.path.expanduser("~") + "/.pond"
    config = None

    if args.command == "init":
        init(home, args)
    else:
        if not os.path.isdir(home):
            print(f"{home} not found, you need to init pond at first")
            sys.exit(1)

        config = json.load(open(f"{home}/pond.json", "r"))

        if args.command == "start":
            start(args, config, home)
        elif args.command == "stop":
            stop(config)
        elif args.command == "info":
            info(home)
        elif args.command == "tags":
            for i in TAGS:
                print(i)


if __name__ == "__main__":
    main()
